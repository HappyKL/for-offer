# 进程控制

## 1.有关进程 《重要》

os运行起来之后会运行0，1，2三个进程

- 0号进程（调度进程）
  - 调度进程，实现进程间调度和切换
  - os代码的一部分，是系统进程

- 1号进程（init进程）
  - 作用
    - 初始化：读取各种各样的系统文件，使用这些文件来初始化os的启动，让os进入多用户状态
    - 托管孤儿进程
    - 原始父进程
  - 怎么运行起来的
    - 该进程代码不属于os的代码，而是存放在了/sbin/init下，当os启动起来之后，os会执行这个程序，将代码加载到内存，进程就运行起来了
- 2号进程（页守护进程）
  - 作用
    - 页守护进程：专门负责虚拟内存的请页操作
  - 怎么运行起来
    - 是os代码一部分，是系统进程

## 2.获取进程ID

```c++
pid_t getpid(void); //进程id
pid_t getppid(void); //父进程id
uid_t getuid(void); //用户id
gid_t getgid(void); //用户组id
```



## 3.fork函数作用

- 程序是如何运行起来的

  - 开辟内存空间
  - 程序拷贝到内存
  - pc指向第一条

- fork

  ```c++
  pid_t fork(void);
  ```

  - 功能
    - 复制子进程

## 4.父子进程各自会执行哪些代码

## 5.父子进程共享操作相同的文件 《重要》

- 共享文件

  - fork之后各自打开

    <img src="%E7%AC%AC5%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6.assets/image-20200415172634218.png" alt="image-20200415172634218" style="zoom:50%;" />

  - fork之前打开

    <img src="%E7%AC%AC5%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6.assets/image-20200415172655140.png" alt="image-20200415172655140" style="zoom:50%;" />



- 子进程继承父进程哪些属性
  - 用户id和组id
  - 进程组id
  - 会话期id
  - 控制终端
  - 当前工作目录
  - 根目录
  - 文件创建方式屏蔽字
  - 环境变量
  - 打开的文件描述符
  - 等等
- 子进程独立的属性
  - 进程ID
  - 不同的父进程ID
  - 父进程设置锁，子进程不能被继承
  - 等等

## 6.exec加载器

```c++
//filename：可执行文件所在的路径名
//argv 传给main函数的参数
//envp 环境变量表
int execve(const char* filename,char** const argv,char** const envp);

```



## 7.system函数，僵尸，孤儿

- system函数

  - 封装了fork和execve函数

  - 函数原型

    ```c++
    int system(const char* command);
    
    ```

- 回收进程资源
  - task_struct空间要释放
  - 其他资源
  - 父进程回收
- 僵尸进程
  - 子进程终止，父进程没回收子进程资源
- 孤儿进程
  - 父进程结束，子进程活着，托管给1号init进程

## 8.wait函数 《重要》

- 功能
  - 主动获取子进程终止状态
  - 主动回收子进程资源
- 进程终止
  - 正常终止
    - main函数return(退出状态)
    - exit(退出状态)
    - _exit(退出状态)
  - 异常终止
    - 自杀，abort函数
    - 他杀，其他信号

- os内核加工终止状态
  - 正常终止
    - 进程终止状态 = 终止原因(正常终止) << 8 | 退出状态的低8位
  - 异常终止
    - 进程终止状态 = 是否产生core文件位 | 终止原因(异常终止) << 8 | 终止该进程的信号编号

- 父进程得到进程终止状态，可以使用位运算提取以下内容
  - 可以判断出子进程终止原因（正常终止/异常终止）
  - 可以获得子进程返回值
  - 可以提取终止子进程异常退出的信号编号

- wait函数原理

  - 内核构建好“进程终止状态”后，会向父进程发送SIGCHLD信号

    - 如果不调用wait函数，会忽略该信号
    - 如果调用了wait函数，会获取进程终止状态并释放子进程资源

  - 函数原型

    ```c++
    int wait(int* status); 
    ```

    

## 9.进程状态

![image-20200416111539938](%E7%AC%AC5%E7%AB%A0-%E8%BF%9B%E7%A8%8B%E6%8E%A7%E5%88%B6.assets/image-20200416111539938.png)



## 10.进程关系和守护进程

- 进程关系
  - 父子关系
  - 进程组关系
  - 会话期关系
    - 进程组组长和终端窗口有联系，如果进程组组长结束掉，会把交互权还给shell程序

- 守护进程